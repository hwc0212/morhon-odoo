# 茂亨Odoo管理脚本

基于原生Odoo针对外贸企业深度优化的管理平台部署工具，采用Docker容器化部署，支持本地和域名两种模式。

## ⚠️ 重要说明

### 单实例设计
- **本脚本仅支持单实例部署**，一台服务器只能部署一个茂亨Odoo实例
- 不支持也不需要多实例部署，确保系统稳定性和资源优化

### 数据安全保护
- **所有数据均映射到Docker卷中**，而非直接映射到主机目录
- 这种设计可以**防止用户误操作**和**避免第三方插件冲突**
- **强烈建议用户不要自行安装第三方模块**，可能导致系统不稳定

### 免责声明
⚠️ **重要提醒**：如果用户自行安装第三方模块导致Odoo出现任何问题（包括但不限于系统崩溃、数据丢失、性能下降等），**茂亨科技概不负责**。我们建议所有功能需求通过官方渠道咨询和定制。

## 茂亨Odoo介绍

茂亨Odoo是基于开源Odoo系统针对外贸企业进行深度优化的管理平台。我们在保持Odoo原生功能完整性的基础上，对外贸业务流程进行了细致的改进和优化，使其更加适合中国外贸企业的实际使用需求。

### 🎯 **优化特色**

#### 业务流程优化
- **进销存流程**：优化采购、库存、销售流程，更符合外贸企业习惯
- **财务管理**：改进应收应付、成本核算、多币种处理逻辑
- **客户管理**：优化客户关系管理和商机跟进流程
- **报价系统**：简化报价流程，提升报价效率

#### 界面和体验优化
- **中文本土化**：深度中文化，符合国内用户习惯
- **界面优化**：调整界面布局，提升操作便利性
- ✅ **报表优化** - 符合外贸企业需求的报表格式
- **工作流优化**：简化复杂操作，提升工作效率

#### 外贸业务适配
- **单证处理**：优化发票、装箱单等外贸单证生成
- **多币种支持**：完善汇率管理和外币结算流程
- **多语言支持**：支持中英文切换，便于国际业务
- **合规性**：符合外贸业务的合规要求

### 📋 **核心模块**

茂亨Odoo包含外贸企业必需的所有核心模块：

- ✅ **销售管理** - 客户管理、报价、订单处理
- ✅ **采购管理** - 供应商管理、采购订单、收货管理  
- ✅ **库存管理** - 多仓库、库存调拨、盘点管理
- ✅ **财务管理** - 应收应付、成本核算、财务报表
- ✅ **项目管理** - 项目跟踪、任务管理、时间记录
- ✅ **制造管理** - 生产计划、工艺路线、质量控制
- ✅ **人力资源** - 员工管理、考勤、薪资管理

### 🌟 **适用企业**

- **制造型外贸企业** - 生产制造+出口贸易
- **贸易型外贸企业** - 采购分销+国际贸易  
- **跨境电商企业** - 线上销售+跨境物流
- **外贸服务企业** - 代理服务+贸易咨询

## 技术特性

- ✅ **智能检测**: 自动检测现有实例（脚本管理/手动部署）
- ✅ **简化部署**: 输入域名即域名模式，不输入即本地模式
- ✅ **智能域名**: 自动处理www跳转，无需手动配置
- ✅ **SSL自动化**: 自动获取和续期Let's Encrypt证书
- ✅ **完整备份**: 数据库、配置文件、环境变量一键备份
- ✅ **跨服务器迁移**: 备份文件可直接在新服务器恢复
- ✅ **实例迁移**: 手动部署实例迁移到脚本管理
- ✅ **性能优化**: 根据服务器配置自动优化参数
- ✅ **安全加固**: 防火墙配置、安全头部、访问控制
- ✅ **健康监控**: 容器健康检查、系统状态监控
- ✅ **数据保护**: Docker卷映射，防止误操作和插件冲突

## 快速开始

### 1. 下载脚本

```bash
wget https://raw.githubusercontent.com/morhon-tech/morhon-odoo/main/morhon-odoo.sh
chmod +x morhon-odoo.sh
```

### 2. 运行脚本

```bash
sudo ./morhon-odoo.sh
```

### 3. 选择操作

脚本会自动检测环境并显示相应菜单：
- **无实例**: 全新部署 或 从备份恢复
- **手动实例**: 迁移到脚本管理
- **脚本实例**: 管理现有实例

### 4. 实例管理功能

对于已部署的实例，脚本提供完整的管理功能：

- **查看实例状态** - 检查容器运行状态、资源使用情况
- **重启实例** - 安全重启Odoo和数据库服务
- **查看日志** - 实时查看应用和系统日志
- **备份实例** - 完整备份数据库、配置和环境变量
- **修改配置** - 安全修改Odoo和系统配置
- **系统状态检查** - 全面检查系统健康状态

## 部署模式

### 本地模式
- **触发条件**: 域名输入为空
- **访问方式**: `http://服务器IP`
- **适用场景**: 内网环境、开发测试

### 域名模式
- **触发条件**: 输入域名
- **适用场景**: 公网环境、生产环境
- **前置条件**: 域名DNS解析到服务器IP，开放80/443端口

### 智能域名处理逻辑

脚本会根据您输入的域名自动配置相应的访问方式和跳转规则：

| 输入域名 | 主访问域名 | 跳转规则 | SSL证书 | 适用场景 |
|---------|-----------|---------|---------|----------|
| `example.com` | `example.com` | `www.example.com` → `example.com` | example.com | 主域名访问 |
| `www.example.com` | `www.example.com` | `example.com` → `www.example.com` | example.com | 带www访问 |
| `sub.example.com` | `sub.example.com` | 无跳转 | sub.example.com | 二级域名 |

**智能域名处理特性**：
- ✅ **自动检测**：无需手动选择，根据输入自动配置
- ✅ **SEO友好**：统一跳转规则，避免重复内容
- ✅ **SSL优化**：自动申请合适的证书覆盖范围
- ✅ **二级域名支持**：完美支持子域名部署

**配置示例**：
```bash
# 输入 example.com
访问 https://example.com ✓ (主站)
访问 https://www.example.com → 跳转到 https://example.com

# 输入 www.example.com  
访问 https://www.example.com ✓ (主站)
访问 https://example.com → 跳转到 https://www.example.com

# 输入 erp.example.com
访问 https://erp.example.com ✓ (主站)
无www相关跳转
```

## 系统要求和VPS配置推荐

### 外贸企业用户规模与配置对照表

| 用户数量 | CPU核心 | 内存 | 存储 | 带宽 | 月费用估算 | 适用场景 |
|---------|---------|------|------|------|-----------|----------|
| 5-15人 | 4核心 | 8GB | 80GB SSD | 5Mbps | $40-80 | 小型外贸团队 |
| 15-50人 | 6核心 | 16GB | 160GB SSD | 10Mbps | $80-150 | 中型外贸企业 |
| 50-150人 | 8核心 | 32GB | 320GB SSD | 20Mbps | $150-300 | 大型外贸企业 |
| 150-300人 | 12核心 | 64GB | 500GB SSD | 50Mbps | $300-500 | 集团型外贸企业 |
| 300-500人 | 16核心 | 128GB | 1TB SSD | 100Mbps | $500-800 | 超大型外贸集团 |

### 最低配置要求（外贸企业优化版）

⚠️ **重要提醒**：由于外贸企业需要同时运行进销存、财务、营销等多个核心模块，**最低配置要求较高**：

- **CPU**: 4核心 2.4GHz+ (推荐Intel/AMD x86_64)
- **内存**: 8GB RAM (推荐16GB+)
- **存储**: 80GB可用空间 (推荐NVMe SSD)
- **网络**: 稳定的互联网连接，5Mbps+
- **系统**: Ubuntu 18.04+ / Debian 10+ / CentOS 7+

### 推荐VPS提供商配置

#### 入门型配置 (5-15人)
```
CPU: 4核心 2.4GHz+
内存: 8GB DDR4
存储: 80GB NVMe SSD
带宽: 5Mbps 不限流量
价格: $40-80/月
适用: 小型外贸团队，基础业务流程
```

#### 标准型配置 (15-50人)
```
CPU: 6核心 2.4GHz+
内存: 16GB DDR4
存储: 160GB NVMe SSD
带宽: 10Mbps 不限流量
价格: $80-150/月
适用: 中型外贸企业，完整业务流程
```

#### 企业型配置 (50-150人)
```
CPU: 8核心 2.4GHz+
内存: 32GB DDR4
存储: 320GB NVMe SSD
带宽: 20Mbps 不限流量
价格: $150-300/月
适用: 大型外贸企业，复杂业务场景
```

#### 集团型配置 (150人以上)
```
CPU: 12核心+ 2.4GHz+
内存: 64GB+ DDR4
存储: 500GB+ NVMe SSD
带宽: 50Mbps+ 不限流量
价格: $300-800/月
适用: 集团型企业，多分支机构
```

### 外贸企业性能基准测试

| 配置等级 | 并发用户 | 页面响应 | 报表生成 | 数据导入 | 复杂查询 |
|---------|---------|---------|---------|---------|----------|
| 入门型 | 15人 | <2秒 | <5秒 | 1000条/分钟 | <1秒 |
| 标准型 | 50人 | <1.5秒 | <3秒 | 3000条/分钟 | <0.5秒 |
| 企业型 | 150人 | <1秒 | <2秒 | 5000条/分钟 | <0.3秒 |
| 集团型 | 300人+ | <0.8秒 | <1.5秒 | 10000条/分钟 | <0.2秒 |

### ⚠️ 配置不足的风险

**使用低于推荐配置的VPS可能导致**：
- 系统响应缓慢，影响业务效率
- 多用户并发访问时系统卡顿
- 复杂报表生成超时失败
- 数据导入导出速度极慢
- 系统内存不足导致服务崩溃
- 财务计算和库存更新延迟

**强烈建议**：
- 外贸企业至少使用 **4核8GB** 配置
- 生产环境推荐 **6核16GB** 或更高
- 使用SSD存储提升数据库性能
- 确保足够的带宽支持文件上传下载

### 为什么需要更高配置？

#### 🔄 **多模块并发运行**
- 进销存管理：库存实时更新、采购订单处理
- 财务管理：应收应付计算、成本核算
- 营销管理：客户关系维护、报价生成
- 外贸专业：单证处理、物流跟踪

#### 📊 **数据密集型操作**
- 大量产品SKU管理
- 复杂的财务报表生成
- 多币种汇率实时计算
- 客户订单历史分析

#### 🌐 **多用户并发访问**
- 销售团队同时录入订单
- 财务人员处理应收应付
- 仓库管理员更新库存
- 管理层查看实时报表

#### 💾 **数据存储需求**
- 产品图片和文档存储
- 客户沟通记录保存
- 财务凭证长期归档
- 业务数据备份冗余

## 命令行用法

```bash
# 交互式菜单（推荐）
sudo ./morhon-odoo.sh

# 初始化环境
sudo ./morhon-odoo.sh init

# 备份实例
sudo ./morhon-odoo.sh backup

# 从备份恢复
sudo ./morhon-odoo.sh restore

# 查看状态
sudo ./morhon-odoo.sh status

# 显示帮助
./morhon-odoo.sh help
```

## 跨服务器迁移

### 源服务器备份
```bash
sudo ./morhon-odoo.sh
# 选择：管理实例 -> 备份实例
# 备份文件：/var/backups/morhon-odoo/backup_YYYYMMDD_HHMMSS.tar.gz
```

### 目标服务器恢复
```bash
# 1. 将脚本和备份文件放在同一目录
# 2. 运行脚本
sudo ./morhon-odoo.sh
# 选择：从备份恢复
# 3. 输入域名（支持多种格式）:
#    - example.com (仅主域名)
#    - www.example.com (主域名+www)
#    - sub.example.com (二级域名)
#    - 直接回车 (本地模式)
```

## 技术架构

### 系统架构
```
用户访问 → Nginx反向代理 → Odoo应用容器 → PostgreSQL数据库容器
```

### 目录结构
```
/opt/morhon-odoo/          # 实例根目录
├── docker-compose.yml     # Docker编排文件
├── .env                   # 环境变量配置
├── config/odoo.conf       # Odoo配置文件
├── logs/                  # 应用日志目录
└── backups/               # 本地备份目录

/var/backups/morhon-odoo/  # 备份存储目录
/var/log/morhon-odoo/      # 脚本日志目录
```

### 容器架构
- **morhon-odoo**: Odoo应用容器
- **morhon-odoo-db**: PostgreSQL数据库容器
- **morhon-network**: 独立Docker网络
- **morhon-pg**: 数据库持久化卷（新版本）
- **morhon-odoo**: Odoo文件持久化卷（新版本）

### 卷名说明
**新部署实例**：`morhon-pg`（数据库）、`morhon-odoo`（应用数据）
**旧版本实例**：`odoo-db-data`（数据库）、`odoo-web-data`（应用数据）
**迁移处理**：脚本自动检测并处理卷名差异

## 备份和恢复

### 备份内容
- 数据库完整备份 (database.sql.gz)
- Odoo配置文件 (config/)
- Docker Compose配置 (docker-compose.yml)
- 环境变量 (.env)
- Nginx配置 (nginx-config)
- 备份信息 (backup_info.txt)

### 备份文件管理
```bash
# 查看备份内容
tar -tzf backup_20250107_143022.tar.gz

# 备份文件位置
/var/backups/morhon-odoo/backup_YYYYMMDD_HHMMSS.tar.gz
```

## 常用操作

### 查看日志
```bash
# 脚本日志
tail -f /var/log/morhon-odoo/morhon-odoo.log

# Odoo日志
sudo docker-compose -f /opt/morhon-odoo/docker-compose.yml logs -f odoo

# Nginx日志
tail -f /var/log/nginx/morhon-odoo-error.log
```

### 重启服务
```bash
# 通过脚本重启
sudo ./morhon-odoo.sh
# 选择：管理实例 -> 重启实例

# 手动重启
cd /opt/morhon-odoo && sudo docker-compose restart
sudo systemctl reload nginx
```

### 修改配置
```bash
# 通过脚本修改
sudo ./morhon-odoo.sh
# 选择：管理实例 -> 修改配置

# 手动修改
sudo nano /opt/morhon-odoo/config/odoo.conf
sudo nano /opt/morhon-odoo/.env
cd /opt/morhon-odoo && sudo docker-compose restart
```

## 故障排除

### 常见问题

**1. 备份文件未找到**
```bash
# 确保文件在同一目录
ls -la *.tar.gz *.sh
chmod +x morhon-odoo.sh
```

**2. 容器启动失败**
```bash
sudo docker ps -a
cd /opt/morhon-odoo && sudo docker-compose logs
```

**3. 无法访问网站**
```bash
# 检查端口和服务
sudo netstat -tlnp | grep -E ":(80|443|8069)"
sudo systemctl status nginx
```

**4. SSL证书问题**
```bash
# 检查DNS解析
nslookup your-domain.com

# 手动获取证书
sudo certbot certonly --webroot -w /var/www/certbot -d your-domain.com
```

**5. 数据库连接失败**
```bash
sudo docker exec morhon-odoo-db pg_isready -U odoo
cd /opt/morhon-odoo && sudo docker-compose restart db
```

## 性能和安全优化

### 自动性能优化

脚本会根据服务器配置自动进行以下优化：

#### Odoo应用层优化
- **Worker进程**: 根据CPU核心数自动计算 (推荐CPU核心数×2)
- **内存限制**: 智能分配内存限制，避免OOM
- **数据库连接池**: 自动配置连接数 (workers×2+4)
- **缓存配置**: 启用会话缓存，优化响应速度
- **日志优化**: 合理的日志级别和轮转策略

#### Nginx反向代理优化
- **Worker进程**: 自动设置为CPU核心数
- **连接数**: 根据系统资源动态调整 (CPU×1024)
- **缓冲区**: 优化代理缓冲区大小，提升传输效率
- **Gzip压缩**: 启用智能压缩，减少带宽使用
- **静态文件缓存**: 7天缓存期，减少服务器负载
- **连接限制**: 防止DDoS攻击，限制单IP连接数

#### 系统内核优化
- **网络参数**: 优化TCP连接数和超时时间
- **内存管理**: 调整swap使用策略和脏页回写
- **文件系统**: 增加文件描述符限制和监控数量
- **日志轮转**: 自动清理旧日志，防止磁盘满

### 安全加固措施

#### 网络安全
- **防火墙**: 自动配置UFW，仅开放必要端口
- **SSL/TLS**: 强制HTTPS，使用TLS 1.2+加密
- **安全头部**: 完整的HTTP安全头部配置
- **连接限制**: 防止暴力破解和DDoS攻击

#### 应用安全
- **数据库隔离**: 禁用数据库管理界面访问
- **敏感路径保护**: 阻止访问配置文件和备份
- **文件上传限制**: 限制上传文件类型和大小
- **会话安全**: 安全的会话超时和管理

#### 系统安全
- **最小权限**: 容器和服务使用最小权限运行
- **数据卷隔离**: Docker卷映射，防止直接文件访问
- **日志审计**: 完整的访问和错误日志记录
- **自动更新**: SSL证书自动续期

### 性能监控指标

脚本提供的系统状态检查包括：

- **容器健康**: Docker容器运行状态和资源使用
- **服务状态**: Nginx、数据库服务运行情况
- **端口监听**: 关键端口的监听状态
- **磁盘空间**: 存储空间使用情况和预警
- **内存使用**: 系统和应用内存占用
- **SSL证书**: 证书有效期和自动续期状态

### 性能调优建议

#### 根据用户数量调优

**小型团队 (1-10人)**:
```bash
# Odoo配置调整
workers = 2
limit_memory_hard = 512M
limit_memory_soft = 384M
```

**中型企业 (10-50人)**:
```bash
# Odoo配置调整
workers = 4
limit_memory_hard = 1024M
limit_memory_soft = 768M
```

**大型企业 (50-200人)**:
```bash
# Odoo配置调整
workers = 8
limit_memory_hard = 2048M
limit_memory_soft = 1536M
```

#### 数据库优化
```bash
# 进入数据库容器进行优化
sudo docker exec -it morhon-odoo-db psql -U odoo postgres

# 数据库维护命令
VACUUM ANALYZE;  # 清理和分析
REINDEX DATABASE postgres;  # 重建索引
```

#### 监控和告警
```bash
# 查看资源使用情况
sudo docker stats morhon-odoo morhon-odoo-db

# 查看Nginx状态
sudo nginx -t && sudo systemctl status nginx

# 查看系统负载
htop  # 或 top
```

## 系统模块说明

### ⚠️ 重要说明

**茂亨Odoo基于原生Odoo模块进行优化**，包含外贸企业运营所需的完整模块：

#### 📦 **内置核心模块**
- ✅ **销售管理** - 客户关系、报价管理、订单处理
- ✅ **采购管理** - 供应商管理、采购订单、收货验收
- ✅ **库存管理** - 多仓库管理、库存调拨、盘点管理
- ✅ **财务管理** - 应收应付、成本核算、财务报表
- ✅ **项目管理** - 项目跟踪、任务管理、时间记录
- ✅ **制造管理** - 生产计划、工艺路线、质量控制（如需要）
- ✅ **人力资源** - 员工管理、考勤管理、薪资管理

#### 🌟 **外贸业务优化**
- ✅ **多币种支持** - 汇率管理、外币结算、汇兑损益
- ✅ **多语言界面** - 中英文切换，国际化支持
- ✅ **单证优化** - 发票、装箱单等外贸单证格式优化
- ✅ **报表优化** - 符合外贸企业需求的报表格式
- ✅ **流程优化** - 针对外贸业务流程的细节改进

#### 🚫 **严禁自装插件**

**请勿自行安装第三方插件！**

**风险说明**：
- 未经测试的插件可能导致系统不稳定
- 插件冲突可能造成数据丢失
- 安全漏洞可能暴露系统风险
- 影响外贸业务的正常运行

**数据保护机制**：
- 所有数据存储在Docker卷中
- 防止用户直接访问和修改文件
- 避免插件安装导致的文件冲突

**免责声明**：如果用户违反建议，自行安装第三方模块导致任何问题，**茂亨科技概不承担任何责任**。

**正确的开发方式**：联系茂亨科技技术团队进行专业功能开发。

## 版本历史

### v6.2 (2025-01-07) - 当前版本

**新增功能**：
- ✨ 简化部署模式选择（输入域名即域名模式）
- ✨ 增强的跨服务器迁移功能
- ✨ 系统状态检查和监控
- ✨ 支持多操作系统
- ✨ 容器健康检查配置
- ✨ **全面性能优化**: 自动调优CPU、内存、网络参数
- ✨ **系统安全加固**: 内核参数优化、日志轮转、文件描述符限制

**改进优化**：
- 🔧 更新卷名规范（morhon-pg、morhon-odoo）
- 🔧 **Nginx高性能配置**: 连接限制、缓存优化、Gzip压缩
- 🔧 **Odoo性能调优**: 智能Worker配置、数据库连接池优化
- 🔧 增强错误处理和日志记录
- � 自o动性能参数调优

**安全增强**：
- 🔒 Docker卷映射防止插件冲突
- 🔒 **完整安全头部**: CSP、HSTS、XSS保护等
- 🔒 **敏感路径保护**: 禁止访问数据库管理、配置文件
- � **连接限制**: 和防DDoS攻击，单IP连接数限制
- � SS函L证书自动获取和续期

**修复问题**：
- 🐛 兼容性处理：自动检测和迁移旧卷名数据
- 🐛 修复函数结构和语法错误
- 🐛 改进备份恢复流程

## 技术支持

### 开源社区
- **GitHub**: https://github.com/morhon-tech/morhon-odoo
- **Issues**: 问题反馈和功能建议
- **Discussions**: 社区讨论

### 商业支持
- **技术咨询**: 部署和配置支持
- **功能开发**: 企业级功能开发
- **培训服务**: 使用培训和最佳实践
- **运维支持**: 7x24小时技术支持

### 联系方式
- **官网**: https://www.morhon.com
- **邮箱**: support@morhon.com

## 许可证

MIT License - 详见 LICENSE 文件

---

**茂亨科技** - 专注外贸企业数字化解决方案，基于Odoo进行深度优化  
**版本**: v6.2  
**更新时间**: 2026-01-07
